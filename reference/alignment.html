
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memory Alignment &#8212; NumPy v1.21.dev0 Manual</title>
    
  <link rel="stylesheet" href="../_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SIMD Optimizations" href="simd/simd-optimizations.html" />
    <link rel="prev" title="NumPy C Code Explanations" href="internals.code-explanations.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
<link rel="stylesheet" href="../_static/numpy.css" type="text/css" />

    <!-- PR #17220: This is added via javascript in versionwarning.js  -->
    <!-- link rel="canonical" href="http://numpy.org/doc/stable/reference/alignment.html" / -->


  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main">
<div class="container-xl">

    <a class="navbar-brand" href="../contents.html">
    
      <img src="../_static/numpylogo.svg" class="logo" alt="logo" />
    
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        
        
        <li class="nav-item ">
            <a class="nav-link" href="../user/index.html">User Guide</a>
        </li>
        
        <li class="nav-item active">
            <a class="nav-link" href="index.html">API reference</a>
        </li>
        
        <li class="nav-item ">
            <a class="nav-link" href="../dev/index.html">Development</a>
        </li>
        
        
      </ul>


      

      <ul class="navbar-nav">
        
          <li class="nav-item">
            <a class="nav-link" href="https://github.com/numpy/numpy" target="_blank" rel="noopener">
              <span><i class="fab fa-github-square"></i></span>
            </a>
          </li>
        
        
          <li class="nav-item">
            <a class="nav-link" href="https://twitter.com/numpy_team" target="_blank" rel="noopener">
              <span><i class="fab fa-twitter-square"></i></span>
            </a>
          </li>
        
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
          <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">

    <div class="bd-toc-item active">
    
  
    <ul class="nav bd-sidenav">
        
        
        
        
          
            
                <li class="">
                    <a href="arrays.html">Array objects</a>
                </li>
            
          
            
                <li class="">
                    <a href="constants.html">Constants</a>
                </li>
            
          
            
                <li class="">
                    <a href="ufuncs.html">Universal functions (ufunc)</a>
                </li>
            
          
            
                <li class="">
                    <a href="routines.html">Routines</a>
                </li>
            
          
            
                <li class="">
                    <a href="typing.html">Typing (numpy.typing)</a>
                </li>
            
          
            
                <li class="">
                    <a href="global_state.html">Global State</a>
                </li>
            
          
            
                <li class="">
                    <a href="distutils.html">Packaging (numpy.distutils)</a>
                </li>
            
          
            
                <li class="">
                    <a href="distutils_guide.html">NumPy Distutils - Users Guide</a>
                </li>
            
          
            
                <li class="">
                    <a href="c-api/index.html">NumPy C-API</a>
                </li>
            
          
            
  
                <li class="active">
                    <a href="internals.html">NumPy internals</a>
                    <ul>
                    
                        <li class="">
                            <a href="internals.code-explanations.html">NumPy C Code Explanations</a>
                        </li>
                    
                        <li class="active">
                            <a href="">Memory Alignment</a>
                        </li>
                    
                    </ul>
                </li>
            
          
            
                <li class="">
                    <a href="simd/simd-optimizations.html">SIMD Optimizations</a>
                </li>
            
          
            
                <li class="">
                    <a href="swig.html">NumPy and SWIG</a>
                </li>
            
          
        
        
        
        
      </ul>
  
  </nav>
          </div>
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="nav section-nav flex-column">
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#numpy-alignment-goals" class="nav-link">Numpy Alignment Goals</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#variables-in-numpy-which-control-and-describe-alignment" class="nav-link">Variables in Numpy which control and describe alignment</a>
        </li>
    
        <li class="nav-item toc-entry toc-h2">
            <a href="#consequences-of-alignment" class="nav-link">Consequences of alignment</a>
        </li>
    
    </ul>
</nav>


              
          </div>
          

          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="memory-alignment">
<span id="alignment"></span><h1>Memory Alignment<a class="headerlink" href="#memory-alignment" title="Permalink to this headline">¶</a></h1>
<div class="section" id="numpy-alignment-goals">
<h2>Numpy Alignment Goals<a class="headerlink" href="#numpy-alignment-goals" title="Permalink to this headline">¶</a></h2>
<p>There are three use-cases related to memory alignment in numpy (as of 1.14):</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Creating structured datatypes with fields aligned like in a C-struct.</p></li>
<li><p>Speeding up copy operations by using uint assignment in instead of memcpy</p></li>
<li><p>Guaranteeing safe aligned access for ufuncs/setitem/casting code</p></li>
</ol>
</div></blockquote>
<p>Numpy uses two different forms of alignment to achieve these goals:
“True alignment” and “Uint alignment”.</p>
<p>“True” alignment refers to the architecture-dependent alignment of an
equivalent C-type in C. For example, in x64 systems <code class="docutils literal notranslate"><span class="pre">numpy.float64</span></code> is
equivalent to <code class="docutils literal notranslate"><span class="pre">double</span></code> in C. On most systems this has either an alignment of
4 or 8 bytes (and this can be controlled in gcc by the option
<code class="docutils literal notranslate"><span class="pre">malign-double</span></code>).  A variable is aligned in memory if its memory offset is a
multiple of its alignment. On some systems (eg sparc) memory alignment is
required, on others it gives a speedup.</p>
<p>“Uint” alignment depends on the size of a datatype. It is defined to be the
“True alignment” of the uint used by numpy’s copy-code to copy the datatype, or
undefined/unaligned if there is no equivalent uint. Currently numpy uses uint8,
uint16, uint32, uint64 and uint64 to copy data of size 1,2,4,8,16 bytes
respectively, and all other sized datatypes cannot be uint-aligned.</p>
<p>For example, on a (typical linux x64 gcc) system, the numpy <code class="docutils literal notranslate"><span class="pre">complex64</span></code>
datatype is implemented as <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">{</span> <span class="pre">float</span> <span class="pre">real,</span> <span class="pre">imag;</span> <span class="pre">}</span></code>. This has “true”
alignment of 4 and “uint” alignment of 8 (equal to the true alignment of
<code class="docutils literal notranslate"><span class="pre">uint64</span></code>).</p>
<dl class="simple">
<dt>Some cases where uint and true alignment are different (default gcc linux):</dt><dd><p>arch     type        true-aln    uint-aln
—-     —-        ——–    ——–
x86_64   complex64          4           8
x86_64   float128          16           8
x86      float96            4           -</p>
</dd>
</dl>
</div>
<div class="section" id="variables-in-numpy-which-control-and-describe-alignment">
<h2>Variables in Numpy which control and describe alignment<a class="headerlink" href="#variables-in-numpy-which-control-and-describe-alignment" title="Permalink to this headline">¶</a></h2>
<p>There are 4 relevant uses of the word <code class="docutils literal notranslate"><span class="pre">align</span></code> used in numpy:</p>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">dtype.alignment</span></code> attribute (<code class="docutils literal notranslate"><span class="pre">descr-&gt;alignment</span></code> in C). This is meant
to reflect the “true alignment” of the type. It has arch-dependent default
values for all datatypes, with the exception of structured types created
with <code class="docutils literal notranslate"><span class="pre">align=True</span></code> as described below.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ALIGNED</span></code> flag of an ndarray, computed in <code class="docutils literal notranslate"><span class="pre">IsAligned</span></code> and checked
by <code class="docutils literal notranslate"><span class="pre">PyArray_ISALIGNED</span></code>. This is computed from <code class="docutils literal notranslate"><span class="pre">dtype.alignment</span></code>.
It is set to <code class="docutils literal notranslate"><span class="pre">True</span></code> if every item in the array is at a memory location
consistent with <code class="docutils literal notranslate"><span class="pre">dtype.alignment</span></code>, which is the case if the data ptr and
all strides of the array are multiples of that alignment.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">align</span></code> keyword of the dtype constructor, which only affects structured
arrays. If the structure’s field offsets are not manually provided numpy
determines offsets automatically. In that case, <code class="docutils literal notranslate"><span class="pre">align=True</span></code> pads the
structure so that each field is “true” aligned in memory and sets
<code class="docutils literal notranslate"><span class="pre">dtype.alignment</span></code> to be the largest of the field “true” alignments. This
is like what C-structs usually do. Otherwise if offsets or itemsize were
manually provided <code class="docutils literal notranslate"><span class="pre">align=True</span></code> simply checks that all the fields are
“true” aligned and that the total itemsize is a multiple of the largest
field alignment. In either case <code class="docutils literal notranslate"><span class="pre">dtype.isalignedstruct</span></code> is also set to
True.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IsUintAligned</span></code> is used to determine if an ndarray is “uint aligned” in
an analogous way to how <code class="docutils literal notranslate"><span class="pre">IsAligned</span></code> checks for true-alignment.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="consequences-of-alignment">
<h2>Consequences of alignment<a class="headerlink" href="#consequences-of-alignment" title="Permalink to this headline">¶</a></h2>
<p>Here is how the variables above are used:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Creating aligned structs: In order to know how to offset a field when
<code class="docutils literal notranslate"><span class="pre">align=True</span></code>, numpy looks up <code class="docutils literal notranslate"><span class="pre">field.dtype.alignment</span></code>. This includes
fields which are nested structured arrays.</p></li>
<li><p>Ufuncs: If the <code class="docutils literal notranslate"><span class="pre">ALIGNED</span></code> flag of an array is False, ufuncs will
buffer/cast the array before evaluation. This is needed since ufunc inner
loops access raw elements directly, which might fail on some archs if the
elements are not true-aligned.</p></li>
<li><p>Getitem/setitem/copyswap function: Similar to ufuncs, these functions
generally have two code paths. If <code class="docutils literal notranslate"><span class="pre">ALIGNED</span></code> is False they will
use a code path that buffers the arguments so they are true-aligned.</p></li>
<li><p>Strided copy code: Here, “uint alignment” is used instead.  If the itemsize
of an array is equal to 1, 2, 4, 8 or 16 bytes and the array is uint
aligned then instead numpy will do <code class="docutils literal notranslate"><span class="pre">*(uintN*)dst)</span> <span class="pre">=</span> <span class="pre">*(uintN*)src)</span></code> for
appropriate N. Otherwise numpy copies by doing <code class="docutils literal notranslate"><span class="pre">memcpy(dst,</span> <span class="pre">src,</span> <span class="pre">N)</span></code>.</p></li>
<li><p>Nditer code: Since this often calls the strided copy code, it must
check for “uint alignment”.</p></li>
<li><p>Cast code: This checks for “true” alignment, as it does
<code class="docutils literal notranslate"><span class="pre">*dst</span> <span class="pre">=</span> <span class="pre">CASTFUNC(*src)</span></code> if aligned. Otherwise, it does
<code class="docutils literal notranslate"><span class="pre">memmove(srcval,</span> <span class="pre">src);</span> <span class="pre">dstval</span> <span class="pre">=</span> <span class="pre">CASTFUNC(srcval);</span> <span class="pre">memmove(dst,</span> <span class="pre">dstval)</span></code>
where dstval/srcval are aligned.</p></li>
</ol>
</div></blockquote>
<p>Note that the strided-copy and strided-cast code are deeply intertwined and so
any arrays being processed by them must be both uint and true aligned, even
though the copy-code only needs uint alignment and the cast code only true
alignment.  If there is ever a big rewrite of this code it would be good to
allow them to use different alignments.</p>
</div>
</div>


              </div>
              
              
              <div class='prev-next-bottom'>
                
    <a class='left-prev' id="prev-link" href="internals.code-explanations.html" title="previous page">NumPy C Code Explanations</a>
    <a class='right-next' id="next-link" href="simd/simd-optimizations.html" title="next page">SIMD Optimizations</a>

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../_static/js/index.d3f166471bb80abb5163.js"></script>


    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2008-2021, The SciPy community.<br/>
        Last updated on Feb 18, 2021.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>